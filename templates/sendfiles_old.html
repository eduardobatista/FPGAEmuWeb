<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DE2 Emulator</title>
  <!-- MDB icon -->
  <!-- <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon"> -->
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="static/css/mdb.min.css">
  <!-- Your custom styles (optional) -->
  <!-- <link rel="stylesheet" href="static/css/style.css"> -->
</head>
<body>

    
    <!--Main Navigation-->
    <header>
        
        <!--Navbar-->
        <nav class="navbar navbar-expand-sm navbar-dark primary-color">

            <!-- Navbar brand -->
            <a class="navbar-brand" href="#">DE2 Emulator</a>
        
            <!-- Collapse button -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav" aria-controls="basicExampleNav"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        
            <!-- Collapsible content -->
            <div class="collapse navbar-collapse" id="basicExampleNav">
        
                <!-- Links -->
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Files
                            <span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/emulation">Emulation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/editor">Editor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/help">Help</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">About</a>
                    </li>
        
                    <!-- Dropdown -->
                    <!-- <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
                        <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </li> -->
        
                </ul>
        
            </div>
            <!-- Collapsible content -->
        
        </nav>
    <!--/.Navbar-->

    </header>
    <!--Main Navigation-->

    <!--Main layout-->
    <main>

        <div class="container mt-4 mb-4">
            <h5>Your <strong>id</strong> is {{ username }}.</h5>     
        </div>

        {%- if filenames is defined -%}
        <div class="container mt-2">
            <button type="button" class="btn btn-primary m-0 ml-1 p-2 float-right" onclick="location.href = '/downloadfile';">Download All</button>
            <h4 class="mb-3">Current files:</h4>
            <ul class="list-group">             
                {% for fname in filenames %}
                    <li class="list-group-item">{{ fname }} 
                        <button class="btn btn-danger btn-sm float-right m-0 ml-1 p-2" onclick="deletefile('{{ fname }}');">Delete</button>
                        <button class="btn btn-primary btn-sm float-right m-0 ml-1 p-2" onclick="rename('{{ fname }}');">Rename</button>
                        <button class="btn btn-primary btn-sm float-right m-0 ml-1 p-2" onclick="location.href = '/editor?file={{ fname }}';">Edit</button>
                        <button id="btl{{ fname }}" class="btn btn-primary btn-sm float-right m-0 ml-1 p-2" onclick="settop('{{ fname }}');" disabled>Set top level</button>                        
                    </li>
                {% endfor %}                
            </ul>
        </div>
        {% else %}
        <div class="container mt-2">
            <h4>No files in your folder.</h4>
        </div>
        {% endif %}

        <div class="container mt-3 w-75">
            
            <form class="md-form" id="meuform" enctype="multipart/form-data">
                <div class="input-group">                    
                    <div class="custom-file">
                    <input type="file" name="fileToUpload" id="fileToUpload" class="custom-file-input m-0"
                        accept=".vhd,.vhdl" multiple>
                    <label class="custom-file-label" for="fileToUpload">Choose file(s) to upload...</label>                    
                    </div> 
                <button type="button" class="btn btn-primary py-2 px-4" onclick="uploadfile();" style="margin-top: 13px;">Upload</button>

                </div>
            </form> 
 
            <!-- <form class="md-form" id="meuform" enctype="multipart/form-data">
                <div class="file-field">
                  <div class="btn btn-primary btn-sm float-left">
                    <span>Choose file(s)</span>
                    <input type="file" name="fileToUpload" id="fileToUpload" accept=".vhd,.vhdl" multiple>
                  </div> -->
                  <!-- <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" placeholder="Upload your file">
                  </div> -->
                <!-- </div>
                <button type="button" class="btn btn-primary p-2" onclick="uploadfile();">Upload</button>
            </form> -->

            <div class="container text-center">
                <button type="button" class="btn btn-danger mt-3" onclick="fpgaCompile();">Compile</button>
            </div>

        </div>

        <!-- <div class="container mt-3 text-center">

            <div id="status">
    
            </div>
    
        </div> -->

        <!-- Full Height Modal Right -->
        <div class="modal fade bottom" id="fullHeightModalRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
            aria-hidden="true">
        
            <!-- Add class .modal-full-height and then add class .modal-right (or other classes from list above) to set a position to the modal -->
            <div class="modal-dialog modal-full-height modal-bottom" role="document">
        
        
            <div class="modal-content">
                <div class="modal-header">
                <h4 class="modal-title w-100" id="myModalLabel">Compilation Process</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <div id="myspinner" class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div id="status">    
                    </div>                    
                </div>
                <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                <button id="gotoemul" type="button" class="btn btn-primary btn-sm" onclick="location.href = '/emulation'">Go to Emulation...</button>
                </div>
            </div>
            </div>
        </div>
        <!-- Full Height Modal Right -->

        <div class="modal fade" id="modalSaveAs" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Rename to...</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div class="md-form mb-5">
                    <input type="text" id="filenameas" class="form-control validate" autofocus>
                    <label data-error="wrong" data-success="right" for="filenameas">File Name</label>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-secondary btn-sm" onclick="renameTo()">Rename<i class="fas fa-paper-plane-o ml-1"></i></button>
                </div>
                </div>
            </div>
        

    </main>
    <!--Main layout-->

    <!--Footer-->
    <footer>

    </footer>
    <!--Footer-->

    <!-- jQuery -->
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="static/js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="static/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="static/js/mdb.min.js"></script>
    <!-- Socket.IO: -->
    <script src="/static/socket.io.js"></script>
    <!-- Your custom scripts (optional) -->
    <script type="text/javascript">

        function uploadfile() { 

            var numFiles = $("#fileToUpload")[0].files.length;
            if ( numFiles > 20 ) {
                alert("Too many files at once.");
                return;
            } else if (numFiles == 0) {
                alert("No file to upload.");
                return;
            }

            var fdata = new FormData( $("#meuform").get(0) );
            
            // var ajaxUrl = "process-upload.php";				
            $.ajax({
                url : 'upload',
                type : "POST",
                data : fdata,
                // both 'contentType' and 'processData' parameters are
                // required so that all data are correctly transferred
                contentType : false,
                processData : false
            }).done(function(response,statusText, xhr){
                if (response == "Done!") {
                    // $("#status").html("<br>File(s) sent.");
                    location.href = "/";
                    // fpgaCompile();
                }                
                // In this callback you get the AJAX response to check
                // if everything is right...
            }).fail(function(response,statusText, xhr){
                // Here you should treat the http errors (e.g., 403, 404)
                // $("#status").html(response); 
                alert(String(xhr));
            }).always(function(){
                // alert("AJAX request finished!");
            });

        }

        window.socket = 0;
        window.socketOn = false;

        function openSocket() {
            window.socket = io.connect('http://' + document.domain + ':' + location.port + '/stream');
            window.socketOn = true; 
            window.socket.on('disconnect',function() {
                window.socketOn = false;
            });
            window.socket.on('filedeleted',function() {
                location.href = '/';
            });
            window.socket.on('message', function(msg){     
                if ($('#status').html() == "") {
                    $('#status').html(String(msg));
                } else {
                    $('#status').append('<br>'+String(msg));
                }                
            });
            window.socket.on('errors', function(msg){
                $('#status').append('<span style="color:red;">Errors:<br>'+String(msg)+"</span>");
                $("#myspinner").hide();
            });
            window.socket.on('success',function(msg){
                $('#status').append(`
                    <span style="color:blue;">
                        Compilation successful!<br>
                        You can now start your emulation.
                    </span>
                `);
                $("#gotoemul").attr('disabled', false);
                $("#myspinner").hide();
            });
            window.socket.on('error',function(msg){
                alert("Error: " + String(msg));
            });
            window.socket.on('filerenamed',function(msg){
                location.href = '/';
            });
      
        }

        window.filetorename = "";
        function rename(fname) {
            window.filetorename = fname;
            $("#filenameas").val(fname);
            $("#modalSaveAs").modal();
            $("#filenameas").focus();
        }

        function renameTo() {
            $("#modalSaveAs").modal('hide');
            val = $("#filenameas").val();
            if ((val != "") && (val != window.filetorename)) {
                if (val.endsWith(".vhd") || val.endsWith(".vhdl")) {
                    if (!window.socketOn) { openSocket(); }
                    window.socket.emit("renamefile",{filename: window.filetorename, filenameto: val});                  
                } else {
                    alert("Error: File does not end with .vhd or .vhdl.")
                }            
            }     
        }

        function deletefile(fname) {
            var txt;
            var r = confirm("Deleting '" + fname + "'.\nAre you sure?");
            if (r == true) {
                if (!window.socketOn) { openSocket(); }
                window.socket.emit("deletefile",fname); 
            } else {
                txt = "You pressed Cancel!";
            }
        }

        function fpgaCompile() {
            $("#status").html("");
            $("#myspinner").show();
            $("#gotoemul").attr('disabled', true);
            $("#fullHeightModalRight").modal();
            if (!window.socketOn) { openSocket(); }
            window.socket.send("Compile")            
        }

        // function fpgaCompile() {
        //     var socket = io.connect('http://' + document.domain + ':' + location.port + '/stream')
        //     socket.send("Compile")
        //     socket.on('message', function(msg){                
        //         $('#status').append('<br>'+String(msg));
        //     });
        //     socket.on('errors', function(msg){
        //         $('#status').append('<span style="color:red;"><br>Errors:<br>'+String(msg)+"</span>");
        //     });
        //     socket.on('success',function(msg){
        //         $('#status').append(`
        //             <br><span style="color:blue;">
        //                 Compilation successful!<br>
        //                 You can now start your emulation.
        //             </span>
        //         `);
        //     });
        // }
        
    </script>

</body>
</html>