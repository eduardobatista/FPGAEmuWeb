{% extends "base.html" %}

{% block styles %}

<style>
    .portname { 
        font-size: large;
        font-weight: bold;
    }
</style>

{% endblock %}

{% block content %}

 <!-- <div class="container mt-2">
            Your <strong>id</strong> is {{ username }}.        
        </div> -->

        {%- if filenames is defined -%}
        <div class="container mt-4">
            <select id="fileselect" class="browser-default custom-select" onchange="openmap()">
                <option selected value="0">Choose file...</option>
                {% for fname in filenames %}
                    <option value="{{fname}}">{{fname}}</option>
                {% endfor %}
            </select>   
        
            <h3 class="mt-3">Port Mapping</h3>
            <p class="mb-2" style="color: red; font-weight: bold;">Only useful for emulation of the top level entity.</p>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="enableMapCheck" onchange="checkchanged()">
                <label class="form-check-label" for="enableMapCheck">
                  Enable Port Mapping
                </label>
            </div>

            <div id="portmap" style="text-size-adjust: 70%;"></div>

            <div id="alerts" class="alert mt-2 mb-2" style="display: none;">
                Mapping has errors.
            </div>          

            <button id="bSave" class='btn btn-sm btn-primary' onclick="buildmap()">Save</button>

        </div>  
        {% endif %}

        

{% endblock %}

{% block scripts %}

    <script type="text/javascript">

        function getform(idx,typesize,direction) {
            var ax = '<select id="Name' + idx + '" onchange="selectChanged(' + idx + ');">';
            if (direction == "in") {
                ax = ax + " <option>SW</option><option>KEY</option>";
                if (typesize == 1) { ax = ax + " <option>CLK_1Hz</option><option>CLK_10Hz</option><option>CLK_500Hz</option>"; }
                ax = ax + "</select>";
            } else {
                ax = ax + `                    
                        <option>LEDR</option><option>HEX0</option><option>HEX1</option><option>HEX2</option>
                        <option>HEX3</option><option>HEX4</option><option>HEX5</option><option>HEX6</option>
                        <option>HEX7</option>
                    </select>                
                `;
            }
            if (typesize == 1) {
                ax = ax + '( <input type="text" maxlength=2 style="width: 30px;" id="rangeA' + idx + '"> )';
            } else {
                ax = ax + '( <input type="text" maxlength=2 style="width: 30px;" id="rangeA' + idx + '"> downto ';
                ax = ax + '<input type="text" maxlength=2 style="width: 30px;" id="rangeB' + idx + '"> )';
            }
            return ax;
        }

        function selectChanged(idx) {
            var val = $("#Name" + idx).children("option:selected").val();
            if (val.startsWith("CLK")) {
                $('#rangeA' + idx).prop( "disabled", true );
            } else {
                $('#rangeA' + idx).prop( "disabled", false );
            }
        }

        function gettypetext(typesize) {
            if (typesize == 1) {
                return "std_logic";
            } else {
                typesize = typesize-1;
                return "std_logic_vector(" + typesize + " downto 0)";
            }
        }

        window.socket = 0;
        window.socketOn = false;
        window.lastportdata = 0;

        function openSocket() {
            window.socket = io.connect('http://' + document.domain + ':' + location.port + '/stream');
            window.socketOn = true;
            window.socket.on('portlist', function(dataa){
                msg = dataa[0];
                if (msg === "Error: ports not found in usertop.") {
                    $("#portmap").html("No ports in entity.");
                    $("#bSave").prop('disabled', true);
                    return;
                } else {
                    $("#bSave").prop('disabled', false);
                }
                msg2 = dataa[1];
                var plist = new Array(); 
                window.lastportdata = msg;
                aux = '<ul class="list-group">';
                for (var ii = 0; ii < msg.length; ii++) {
                    plist.push(msg[ii].name);
                    aux = aux + '<li class="list-group-item" id="item' + ii + '"><span class="portname">';
                    aux = aux + msg[ii].name + "</span> " + gettypetext(msg[ii].typesize) + " => ";                   
                    aux = aux +  getform(ii,msg[ii].typesize,msg[ii].direction);
                    aux = aux + ' </li>\n';
                }
                aux = aux + '</ul>';
                $("#portmap").html(aux);
                for (var ii = 1; ii < msg2.length; ii++) {
                    var idx = plist.indexOf(String(msg2[ii][0]));
                    if (idx > -1) {
                        $("#Name" + idx + " option").filter(function() {
                            return $(this).text() == msg2[ii][1];
                        }).prop('selected', true);
                        $( "#rangeA" + idx).val(msg2[ii][2]);
                        if (msg2[ii].length == 4) {
                            $( "#rangeB" + idx).val(msg2[ii][3]);
                        }                                             
                    }
                }
                if (msg2[0] == "enabled") {
                    $('#enableMapCheck').prop('checked', true);                    
                } else {
                    $('#enableMapCheck').prop('checked', false);
                }
                checkchanged();
                if (msg2[0] == "enabled") {
                    for (var ii = 0; ii < msg.length; ii++) {
                        selectChanged(ii);
                    }
                }
                
                // alert('File saved successfully!');
                // $("#filesavedmsg").html('File ' + String(msg) + " saved successfully!");
                // $("#centralModalSm").modal();
                // window.filechanged = false;
                // if (window.lastfilesaveopt >= 1) {
                //     location.href = "/editor?file=" + String(msg);
                // }
            }); 
            window.socket.on('mapsavesuccess', function(msg){
                $("#alerts").html("Map saved successfully!<br><strong>Don't forget to recompile</strong>.");
                $("#alerts").removeClass("alert-danger").addClass("alert-primary").delay(100).fadeIn(300);
            });
        }

        function checkchanged() {
            ckb = $("#enableMapCheck").is(':checked');
            if (ckb) {
                $('[id^=Name]').prop( "disabled", false );
                $('[id^=range]').prop( "disabled", false );
            } else {
                $('[id^=Name]').prop( "disabled", true );
                $('[id^=range]').prop( "disabled", true );
            }
        }

        function openmap() {  
            $("#alerts").hide();
            var val = $("#fileselect").children("option:selected").val();
            if (val != 0) {
                if (!window.socketOn) {
                    openSocket();
                }
                window.socket.emit("getmap",val);          
            } else {
                $("#portmap").html("");
            }           

        }

        function buildmap() {
            var val = $("#fileselect").children("option:selected").val();
            $("#alerts").hide();
            if (val != 0) {
                errorflag = false;
                axx = "";
                ax2 = "";
                for (var jj = 0; jj < window.lastportdata.length; jj++) {
                    name = $( "#Name" + jj + " option:selected" ).text();
                    rangeA = $( "#rangeA" + jj).val();
                    if (name.startsWith('CLK')) {
                        axx = axx + window.lastportdata[jj].name + " => " + name
                    } else {
                        axx = axx + window.lastportdata[jj].name + " => " + name + "(" + rangeA;
                    }
                    ax2 = ax2 + window.lastportdata[jj].name + ":"
                    if (window.lastportdata[jj].typesize == 1) {
                        if (name.startsWith('CLK')) { axx = axx + ", ";  }
                        else { axx = axx + "), "; }
                        ax2 = ax2 + name + "," + rangeA + "\n"
                        if (!portok(1,name,rangeA,0)) {
                            $("#item" + jj).addClass("list-group-item-danger");
                            errorflag = true;
                        } else {
                            $("#item" + jj).removeClass("list-group-item-danger");
                        }
                    } else {
                        rangeB = $( "#rangeB" + jj).val();
                        axx = axx + " downto " +  rangeB + "), ";
                        ax2 = ax2 + name + "," + rangeA + "," + rangeB + "\n";
                        if (!portok(window.lastportdata[jj].typesize,name,rangeA,rangeB)) {
                            $("#item" + jj).addClass("list-group-item-danger");
                            errorflag = true;
                        } else {
                            $("#item" + jj).removeClass("list-group-item-danger");
                        }
                    }
                }
                ckb = $("#enableMapCheck").is(':checked');
                if (errorflag && ckb) {
                    $("#alerts").html("Mapping has errors.")
                    $("#alerts").removeClass("alert-primary").addClass("alert-danger").delay(100).fadeIn(300);
                    return; 
                }
                window.socket.emit("savemap",{filename: val, data: (ckb ? axx.slice(0,-2) : "") + "\n" + ax2.slice(0,-1)});                
            } 
        }

        function portok(tsize,name,rangeA,rangeB) {
            rangeA = parseInt(rangeA);
            rangeB = parseInt(rangeB);
            if ( name.startsWith("CLK")) {
                return true;
            } else if ( isNaN(rangeA) || isNaN(rangeB)) {
                return false;
            } else if (tsize == 1) { rangeB = rangeA; } 
            var dif = rangeA - rangeB;
            // console.log(tsize + name + rangeA + "" + rangeB + "" + dif);
            if (rangeA < rangeB) {
                return false;                
            } else if ( dif != (tsize-1) ) {
                return false;                
            } else if (((name == "SW") || (name == "LEDR")) && ((rangeA > 17) || (rangeB > 17))) {
                return false;                
            } else if ( (name == "KEY") && ((rangeA > 3) || (rangeB > 3)) ) {
                return false;                
            } else if ( (name.startsWith("HEX")) && ((rangeA > 6) || (rangeB > 6)) ) {
                return false;                
            }
            return true;
        }

        function maperror(idx) {
            $("#item" + idx).addClass("list-group-item-danger");
        }


    </script>

{% endblock %}