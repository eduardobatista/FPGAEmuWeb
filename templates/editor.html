{% extends "base.html" %}

{% block styles %}

  <style>
      #editor { 
        position: relative;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        height: 500px;
        width: 100%;
        margin-top: 5px;
    }
  </style>
{% endblock %}

{% block content %}

        <!-- <div class="container mt-2">
            Your <strong>id</strong> is {{ username }}.        
        </div> -->

        <input type="hidden" value="{{toplevel}}" id="toplevel">

        {%- if filenames is defined -%}
        <div class="container mt-2">
            <select id="fileselect" class="browser-default custom-select" onchange="openfile()">
                <option selected value="0">Choose file...</option>
                {% for fname in filenames %}
                    <option value="{{fname}}">{{fname}}</option>
                {% endfor %}
            </select>
            <button class="btn btn-primary btn-sm" onclick="savefile(0);">Save</button>
            <button class="btn btn-primary btn-sm" onclick="savefileas()">Save As...</button>
            <button class="btn btn-primary btn-sm" onclick="newfile();">New</button>
            <button class="btn btn-primary btn-sm" id="toplevelbtn" onclick="settop();" disabled>Set Top Level</button>
            <div class="dropdown d-inline">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Templates
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="#" onclick="fillWithUsertop();">usertop.vhd</a>
                    <a class="dropdown-item" href="#" onclick="fillWithUsertest();">usertest.vhd</a>
                    <!-- <a class="dropdown-item" href="#">Something else here</a> -->
                </div>
            </div>             
            <button class="btn btn-warning btn-sm" onclick="analyze()">Analyze Current File</button>
            <button class="btn btn-danger btn-sm" onclick="fpgaCompile()">Compile</button><br>
        </div>
        
        <div class="container mt-0">
            <div id="editor"></div>
        </div>
        {% endif %}

        <!-- Button trigger modal -->
        <!-- <button type="button" class="btn btn-primary">
            Launch demo modal
        </button> -->
        
        <!-- Full Height Modal Right -->
        <div class="modal fade bottom" id="fullHeightModalRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
            aria-hidden="true">
        
            <!-- Add class .modal-full-height and then add class .modal-right (or other classes from list above) to set a position to the modal -->
            <div class="modal-dialog modal-full-height modal-bottom" role="document">
        
        
            <div class="modal-content">
                <div class="modal-header">
                <h4 class="modal-title w-100" id="myModalLabel">Compilation Process</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <div id="myspinner" class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div id="status">    
                    </div>                    
                </div>
                <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                <button id="gotoemul" type="button" class="btn btn-primary btn-sm" onclick="location.href = '/emulation'">Go to Emulation...</button>
                </div>
            </div>
            </div>
        </div>
        <!-- Full Height Modal Right -->

        <div class="modal fade" id="centralModalSm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"  aria-hidden="true">
            <!-- Change class .modal-sm to change the size of the modal -->
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                <!-- <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">Modal title</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div> -->
                <div id="filesavedmsg" class="modal-body">
                    File saved successfully!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalSaveAs" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Save As...</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div class="md-form mb-5">
                    <input type="text" id="filenameas" class="form-control validate">
                    <label data-error="wrong" data-success="right" for="filenameas">File Name</label>
                    </div>
                </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button class="btn btn-secondary btn-sm" onclick="saveAsOrNew()">Save<i class="fas fa-paper-plane-o ml-1"></i></button>
                    </div>
                    <div id="saveasalert" data-dismiss="alert" class="alert alert-danger hide" role="alert">
                        File extension must be ".vhd".                  
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="modalError" tabindex="-1" role="dialog" aria-labelledby="modalErrorLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="modalErrorLabel">Error</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                <button type="button" id="bcloseerr" class="btn btn-danger btn-sm" data-dismiss="modal">Close</button>
                <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div>
            </div>
        </div>

        
{% endblock %}

{% block scripts %}

    <!-- Your custom scripts (optional) -->
    <script src="/static/ace/ace.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript">

        
        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        };
        $(document).ready(function() {
            var arq = getUrlParameter("file");
            if (arq != undefined) {
                $('#fileselect').val(arq);
                openfile(); 
            }
            $('#saveasalert').hide();
            $("#filenameas").on('keyup', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    saveAsOrNew();
                }
            });
            $('#modalSaveAs').on('shown.bs.modal', function () {
                $('#filenameas').focus();
            });
            $('#modalError').on('shown.bs.modal', function () {
                $('#bcloseerr').focus();
            })  
        });

        function errorMessage(msg) {
            $("#errorMessage").html(msg);
            $("#modalError").modal();
        }

        window.filechanged = false;

        var editor = ace.edit("editor");
        // editor.setTheme("ace/theme/monokai");
        editor.setTheme("ace/theme/dreamweaver");  
        editor.session.setMode("ace/mode/vhdl");
        editor.commands.addCommand({
            name: 'mySaveFile',
            bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
            exec: function(editor) {
                savefile(0);
            },
            readOnly: false // false if this command should not apply in readOnly mode
        });
        editor.session.on('change', function(delta) {
            // delta.start, delta.end, delta.lines, delta.action
            window.filechanged = true;
        });
        editor.resize();

        window.socket = 0;
        window.socketOn = false;
        window.lastfilesaveopt = 0;
        window.isnewfile = false;

        function openSocket() {
            window.socket = io.connect('http://' + document.domain + ':' + location.port + '/stream');
            window.socketOn = true;
            window.socket.on('filesaved', function(msg){
                // alert('File saved successfully!');
                $("#filesavedmsg").html('File ' + String(msg) + " saved successfully!");
                $("#centralModalSm").modal();
                window.filechanged = false;
                if (window.lastfilesaveopt >= 1) {
                    location.href = "/editor?file=" + String(msg);
                }
            }); 
            window.socket.on('filecontent', function(msg){
                editor.setValue(msg);
                window.filechanged = false;
            });
            window.socket.on('message', function(msg){     
                if ($('#status').html() == "") {
                    $('#status').html(String(msg));
                } else {
                    $('#status').append('<br>'+String(msg));
                }                
            });
            window.socket.on('errors', function(msg){
                $('#status').append('<br><span style="color:red;">Errors:<br>'+String(msg)+"</span>");
                $("#myspinner").hide();
            });
            window.socket.on('success',function(msg){
                $('#status').append(`
                    <span style="color:blue;">
                        Compilation successful!<br>
                        You can now start your emulation.
                    </span>
                `);
                $("#gotoemul").attr('disabled', false);
                $("#myspinner").hide();
            });
            window.socket.on('asuccess',function(msg){
                $('#status').append(`
                    <span style="color:blue;">
                        Analysis end up successfully!
                    </span>
                `);
                $("#myspinner").hide();
            });
            window.socket.on('disconnect', function(msg){
                window.socketOn = false;
            });
            window.socket.on('error',function(msg){
                errorMessage(String(msg));
            });
        }

        function openfile() {  

            var val = $("#fileselect").children("option:selected").val();
            if (val != 0) {
                if (!window.socketOn) {
                    openSocket();
                }
                window.socket.emit("getfile",val);
                checktoplevel(val);
                // $('#editor').show();            
            } else {
                editor.setValue("");
                $("#toplevelbtn").text('Set Top Level');
                $("#toplevelbtn").prop('disabled', true);
                // $('#editor').hide();
            }           

        }

        function savefile(opt) {
            /*
                opt = 0: Save.
                opt = 1: Save As.
                opt = 2: Save New.
            */
            $('#saveasalert').hide(); 
            window.lastfilesaveopt = opt; 

            var val = $("#fileselect").children("option:selected").val();
            // if (((opt == 1) && (val != 0)) || (opt == 2)) {
            if ( opt > 0 ) {
                val = $("#filenameas").val();
            } 

            if (val != 0) {
                if ( val.endsWith(".vhd") ) {
                    if (!window.socketOn) { openSocket(); }
                    $("#modalSaveAs").modal('hide');
                    if (opt == 2) {
                        window.socket.emit("savefile",{filename: val, data:""});                         
                    } else {
                        window.socket.emit("savefile",{filename: val, data:editor.getValue()}); 
                    }                               
                } else {
                    $('#saveasalert').show();
                }                
            }          

        }

        function saveAsOrNew() {
            if (!window.isnewfile) {
                savefile(1);
            } else {
                savefile(2);
            }
        }

        function savefileas() {
            window.isnewfile = false;
            $("#modalSaveAs").modal();   
        }

        function newfile() {
            window.isnewfile = true;
            $("#modalSaveAs").modal();
        }

        function fpgaCompile() {
            if (window.filechanged) {
                var r = confirm("The current file is not saved.\nStart compilation anyways?");
                if (r == false) {
                    return;
                }
            }
            $("#status").html("");
            $("#myspinner").show();
            $("#gotoemul").attr('disabled', true);
            $("#fullHeightModalRight").modal();
            if (!window.socketOn) {
                openSocket();
            }
            window.socket.send("Compile")            
        }

        function analyze() {
            if (window.filechanged) {
                var r = confirm("The current file is not saved.\nAnalyze anyways?");
                if (r == false) {
                    return;
                }
            }
            var val = $("#fileselect").children("option:selected").val();
            if (val != 0) {               
                $("#status").html("");
                $("#myspinner").show();
                $("#gotoemul").attr('disabled', true);
                $("#fullHeightModalRight").modal();
                if (!window.socketOn) {
                    openSocket();
                }
                window.socket.emit("Analyze",val)
            }
        }

        function checktoplevel(fname) {
            if (fname == ($("#toplevel").val() + ".vhd")) {
                $("#toplevelbtn").prop('disabled', true);
                $("#toplevelbtn").text("File is Top Level");
            } else {
                $("#toplevelbtn").prop('disabled', false);
                $("#toplevelbtn").text("Set Top Level");
            }
        }

        function settop() {
            var val = $("#fileselect").children("option:selected").val();
            if (val != 0) {
                var tlevelname = val.slice(0,-4);
                $.post("/settoplevel",{ toplevelfile: tlevelname } ).done(
                    function (data) {
                        $("#toplevel").val(tlevelname);
                        checktoplevel(val);
                        data = "";
                    }
                );
            }
        }

        var usertoptemplate = `library ieee;
use ieee.std_logic_1164.all;

entity usertop is
port(
	KEY: in std_logic_vector(3 downto 0);
	SW: in std_logic_vector(17 downto 0);
	LEDR: out std_logic_vector(17 downto 0);
	HEX0,HEX1,HEX2,HEX3,HEX4,HEX5,HEX6,HEX7	: out std_logic_vector(6 downto 0)
	);
end usertop;

architecture rtl of usertop is
begin
    
    LEDR(0) <= SW(0);
    LEDR(1) <= SW(1);
    LEDR(2) <= SW(2);
    LEDR(3) <= SW(3);
    
    LEDR(16) <= KEY(0);
    LEDR(17) <= KEY(1);
    
    HEX6 <= "0000110";
    HEX5 <= "0000110";
    HEX4 <= "1000111";
    HEX3 <= "0010010";
    HEX2 <= "1111001";
    HEX1 <= "1000000";
    HEX0 <= "0010010";

end rtl;`;

        var usertesttemplate=`library ieee;
use ieee.std_logic_1164.all;

entity usertest is
end usertest;

architecture tb of usertest is

    -- Signal declarations:
    signal A,B : std_logic;
    signal C: std_logic_vector(2 downto 0);
    
    -- Component declarations:
    component mycomponent is port ( 
      PortA,PortB: in std_logic;
      PortC: out std_logic_vector(2 downto 0) );
    end component;

begin

    -- Component instantiation and port map:
    DUT : mycomponent port map (PortA => A, PortB => B, PortC => C);
    
    -- Stimuli:
    A <= '0', '1' after 20 ns, '0' after 40 ns;
    B <= '0', '1' after 10 ns, '0' after 20 ns, '1' after 30 ns;
    
end tb;`;

        function fillWithUsertop() {
            editor.insert(usertoptemplate);
            editor.focus();
        }

        function fillWithUsertest() {
            editor.insert(usertesttemplate);
            editor.focus();
        }
        
    </script>
    
{% endblock %}