<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DE2 Emulator</title>
  <!-- MDB icon -->
  <!-- <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon"> -->
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="static/css/mdb.min.css">
  <!-- Your custom styles (optional) -->
  <!-- <link rel="stylesheet" href="static/css/style.css"> -->

  <style>
      #editor { 
        position: relative;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        height: 500px;
        width: 100%;
        margin-top: 5px;
    }
  </style>

</head>
<body>

    
    <!--Main Navigation-->
    <header>
        
        <!--Navbar-->
        <nav class="navbar navbar-expand-sm navbar-dark primary-color">

            <!-- Navbar brand -->
            <a class="navbar-brand" href="#">DE2 Emulator</a>
        
            <!-- Collapse button -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav" aria-controls="basicExampleNav"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        
            <!-- Collapsible content -->
            <div class="collapse navbar-collapse" id="basicExampleNav">
        
                <!-- Links -->
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Files</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/emulation">Emulation</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Editor</a>
                    </li>
        
                    <!-- Dropdown -->
                    <!-- <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
                        <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </li> -->
        
                </ul>
        
            </div>
            <!-- Collapsible content -->
        
        </nav>
    <!--/.Navbar-->

    </header>
    <!--Main Navigation-->

    <!--Main layout-->
    <main>

        <div class="container mt-2">
            Your <strong>id</strong> is {{ username }}.        
        </div>

        {%- if filenames is defined -%}
        <div class="container mt-2">
            <select id="fileselect" class="browser-default custom-select" onchange="openfile()">
                <option selected value="0">Choose file...</option>
                {% for fname in filenames %}
                    <option value="{{fname}}">{{fname}}</option>
                {% endfor %}
            </select>            
            <button class="btn btn-primary btn-sm" onclick="savefile(0);">Save</button>
            <button class="btn btn-primary btn-sm" onclick="savefileas()">Save As...</button>
            <button class="btn btn-primary btn-sm" onclick="newfile();">New</button>
            <button class="btn btn-danger btn-sm" onclick="fpgaCompile()">Compile</button>
        </div>
        
        <div class="container mt-0">
            <div id="editor"></div>
        </div>
        {% endif %}

        <!-- Button trigger modal -->
        <!-- <button type="button" class="btn btn-primary">
            Launch demo modal
        </button> -->
        
        <!-- Full Height Modal Right -->
        <div class="modal fade bottom" id="fullHeightModalRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
            aria-hidden="true">
        
            <!-- Add class .modal-full-height and then add class .modal-right (or other classes from list above) to set a position to the modal -->
            <div class="modal-dialog modal-full-height modal-bottom" role="document">
        
        
            <div class="modal-content">
                <div class="modal-header">
                <h4 class="modal-title w-100" id="myModalLabel">Compilation Process</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <div id="myspinner" class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div id="status">    
                    </div>                    
                </div>
                <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                <button id="gotoemul" type="button" class="btn btn-primary btn-sm" onclick="location.href = '/emulation'">Go to Emulation...</button>
                </div>
            </div>
            </div>
        </div>
        <!-- Full Height Modal Right -->

        <div class="modal fade" id="centralModalSm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"  aria-hidden="true">

            <!-- Change class .modal-sm to change the size of the modal -->
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                <!-- <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">Modal title</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div> -->
                <div id="filesavedmsg" class="modal-body">
                    File saved successfully!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalSaveAs" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Save As...</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div class="md-form mb-5">
                    <input type="text" id="filenameas" class="form-control validate">
                    <label data-error="wrong" data-success="right" for="filenameas">File Name</label>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-secondary btn-sm" onclick="saveAsOrNew()">Save<i class="fas fa-paper-plane-o ml-1"></i></button>
                </div>
                </div>
            </div>
            </div>

        

    </main>
    <!--Main layout-->

    <!--Footer-->
    <footer>

    </footer>
    <!--Footer-->

    <!-- jQuery -->
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="static/js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="static/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="static/js/mdb.min.js"></script>
    <!-- Socket.IO: -->
    <script src="/static/socket.io.js"></script>
    <!-- Your custom scripts (optional) -->
    <script src="/static/ace/ace.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript">

        // $("#fullHeightModalRight").on('show.bs.modal', function(){
        //     $("#gotoemul").attr('disabled', true);
        //     fpgaCompile();
        // });

        window.filechanged = false;

        var editor = ace.edit("editor");
        // editor.setTheme("ace/theme/monokai");
        editor.setTheme("ace/theme/dreamweaver");  
        editor.session.setMode("ace/mode/vhdl");
        editor.commands.addCommand({
            name: 'mySaveFile',
            bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
            exec: function(editor) {
                savefile(0);
            },
            readOnly: false // false if this command should not apply in readOnly mode
        });
        editor.session.on('change', function(delta) {
            // delta.start, delta.end, delta.lines, delta.action
            window.filechanged = true;
        });
        editor.resize();

        window.socket = 0;
        window.socketOn = false;
        window.lastfilesaveopt = 0;
        window.isnewfile = false;

        function openSocket() {
            window.socket = io.connect('http://' + document.domain + ':' + location.port + '/stream');
            window.socketOn = true;
            window.socket.on('filesaved', function(msg){
                // alert('File saved successfully!');
                $("#filesavedmsg").html('File ' + String(msg) + " saved successfully!");
                $("#centralModalSm").modal();
                window.filechanged = false;
                if (window.lastfilesaveopt >= 1) {
                    location.href = "/editor";
                }
            }); 
            window.socket.on('filecontent', function(msg){
                editor.setValue(msg);
                window.filechanged = false;
            });
            window.socket.on('message', function(msg){     
                if ($('#status').html() == "") {
                    $('#status').html(String(msg));
                } else {
                    $('#status').append('<br>'+String(msg));
                }                
            });
            window.socket.on('errors', function(msg){
                $('#status').append('<span style="color:red;">Errors:<br>'+String(msg)+"</span>");
                $("#myspinner").hide();
            });
            window.socket.on('success',function(msg){
                $('#status').append(`
                    <span style="color:blue;">
                        Compilation successful!<br>
                        You can now start your emulation.
                    </span>
                `);
                $("#gotoemul").attr('disabled', false);
                $("#myspinner").hide();
            });
            window.socket.on('disconnect', function(msg){
                window.socketOn = false;
            });
        }

        function openfile() {  

            var val = $("#fileselect").children("option:selected").val();
            if (val != 0) {
                if (!window.socketOn) {
                    openSocket();
                }
                window.socket.emit("getfile",val); 
            } else {
                editor.setValue("");
            }           

        }

        function savefile(opt) {

            window.lastfilesaveopt = opt; 

            var val = $("#fileselect").children("option:selected").val();
            if (((opt == 1) && (val != 0)) || (opt == 2)) {
                val = $("#filenameas").val();
            } 

            if (val != 0) {
                if (val.endsWith(".vhd") || val.endsWith(".vhdl")) {
                    if (!window.socketOn) { openSocket(); }
                    if (opt == 2) {
                        window.socket.emit("savefile",{filename: val, data:""});
                    } else {
                        window.socket.emit("savefile",{filename: val, data:editor.getValue()});
                    }                    
                }                
            }          

        }

        function saveAsOrNew() {
            if (!window.isnewfile) {
                savefile(1);
            } else {
                savefile(2);
            }
        }

        function savefileas() {
            window.isnewfile = false;
            $("#modalSaveAs").modal();            
        }

        function newfile() {
            window.isnewfile = true;
            $("#modalSaveAs").modal();
        }

        function fpgaCompile() {
            if (window.filechanged) {
                var r = confirm("The current file is not saved.\nStart compilation anyways?");
                if (r == false) {
                    return;
                }
            }
            $("#status").html("");
            $("#myspinner").show();
            $("#gotoemul").attr('disabled', true);
            $("#fullHeightModalRight").modal();
            if (!window.socketOn) {
                openSocket();
            }
            window.socket.send("Compile")            
        }
        
    </script>

</body>
</html>