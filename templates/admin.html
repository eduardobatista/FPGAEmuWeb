{% extends "base.html" %}


    {% block styles %}
    {% endblock %} 


    {% block content %}

    <div class="container mt-3">

        {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="alert alert-danger">
                {{ messages[0] }}
            </div>
        {% endif %}
        {% endwith %}  

        {% if current_user.role == 'Admin' %}

        <h2 class="mb-2">Cloud Database Info</h2>

        <div class="form-group form-inline">
            <!-- <label for="clouddbinfo">Cloud Db Info</label> -->
            <input type="text" class="form-control w-100" id="clouddbinfo" aria-describedby="emailHelp" placeholder="Enter email" value="{{clouddbinfo}}">
            <button class="btn btn-primary btn-sm" onclick="saveCloudDbInfo();">Save</button>
            <button class="btn btn-primary btn-sm" onclick="checkCloudDb();">Check Cloud DB Info</button>
        </div> 


        <i id="running" class="fa fa-cog fa-spin fa-2x fa-fw" style="display: none;"></i>
        <div id="cloudinfo">
            
        </div>

        <h2 class="mb-2 mt-4">Email Info and Credentials</h2>

        <div class="form-group">
            <!-- <label for="emailinfo">Example textarea</label> -->
            <textarea class="form-control mb-0 pb-0" id="emailInfo" rows="5">{{emailinfo}}</textarea>
        </div>
        <button class="btn btn-primary btn-sm mt-0" onclick="saveEmailInfo();">Save</button>
        <div id="emailresponse">
            
        </div>

        <!-- <div class="form-group">
            <button class="btn btn-primary btn-sm" onclick="checkCloudDb();">Check Cloud DB Info</button>
        </div> -->

       
    </div>

        {%- if userlist is defined -%}
    <div class="container mt-4">
        <h2>User List</h2>

        <table class="table">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Role</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>

                
                {% for uu in userlist %}
                <tr>
                    <td>{{ uu.name }}</td>
                    <td>{{ uu.email }}</td>
                    <td>
                        {% if uu.email == current_user.email %}
                            <select class="custom-select" disabled>
                        {% else %}
                            <input type="hidden" id="val{{loop.index}}" value="{{uu.email}}">
                            <select class="custom-select" id="sel{{loop.index}}" onchange="changerole({{loop.index}});">
                        {% endif %}
                            {% if uu.role == 'Student' %}
                                <option value="Student" selected>Student</option>
                                <option value="Professor">Professor</option>
                                <option value="Admin">Admin</option>
                            {% elif uu.role == 'Admin' %}
                                <option value="Student">Student</option>
                                <option value="Professor">Professor</option>
                                <option value="Admin" selected>Admin</option>
                            {% else %}
                                <option value="Student">Student</option>
                                <option value="Professor" selected>Professor</option>
                                <option value="Admin">Admin</option>
                            {% endif %}
                          </select>
                    </td>
                    <td>
                        {% if uu.email == current_user.email %}
                            <button class="btn btn-danger btn-sm m-0 ml-1 p-2" disabled>Delete</button>
                        {% else %}
                            <button class="btn btn-danger btn-sm m-0 ml-1 p-2" onclick="delUser({{loop.index}});">Delete</button>
                        {% endif %}
                        
                    </td>
                </tr>
                <!-- <li class="list-group-item" id="user{{uu}}">   -->
                    <!-- <button class="btn btn-danger btn-sm float-right m-0 ml-1 p-2" onclick="deletefile('{{ fname }}.vhd');">Delete</button>
                    <button class="btn btn-primary btn-sm float-right m-0 ml-1 p-2" onclick="rename('{{ fname }}.vhd');">Rename</button>
                    <button class="btn btn-primary btn-sm float-right m-0 ml-1 p-2" onclick="location.href = '/editor?file={{ fname }}.vhd';">Edit</button> -->
                    <!-- <button id="btl{{ fname }}" class="btn btn-primary btn-sm float-right m-0 ml-1 p-2" onclick="settop('{{ fname }}');" disabled>Set top level</button>                         -->
                <!-- </li> -->
                {% endfor %}



            </tbody>
          </table>

        {% endif %}

        {% endif %}
        
    </div>



    {% endblock %}



    {% block scripts %}
        <script>

            function delUser(userid) {
                user = $("#val" + userid).val();
                if (confirm('Really delete user ' + user + '?')) {
                    $.post("/deleteuser",{email: user}).done( function (data) {
                        window.location.href = "/admin";
                    });
                }                 
            }

            function changerole(userid) {
                user = $("#val" + userid).val();
                newrole = $("#sel" + userid + " option:selected").text();
                $("#sel" + userid).prop('disabled', true);
                $.post("/changerole",{ email: user, newrole: newrole} ).done(
                    function (data) {
                        if (data == "Role changed!") {
                            $("#sel" + userid).prop('disabled', false);
                        } else {
                            alert("Error changing role.")
                        }
                    }
                );
            }

            function checkCloudDb() {
                $("#running").css("display", "block");
                $.get("/clouddbinfo",{}).done( function (data) {
                    $('#cloudinfo').html(data);
                    $("#running").css("display", "none");
                });                                 
            }

            function saveCloudDbInfo() {
                $.post("/saveclouddbinfo",{"info":$("#clouddbinfo").val()}).done( function (data) {
                    $('#cloudinfo').html(data);
                });
            }

            function saveEmailInfo() {
                $.post("/saveemailinfo",{"info":$("textarea#emailInfo").val()}).done( function (data) {
                    $('#emailresponse').html(data);
                });
            }

            

        </script>



    {% endblock %} 